<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
      }
      input {
        font-size: 2em;
        width: 600px;
      }
    </style>
  </head>
  <body>
    <button class="start">go</button>
    <button class="reset">reset</button>
    <div><input></div>
    <script src="//socketpeer-media.herokuapp.com/socketpeer/socketpeer.js"></script>
    <script>
      var code = location.search.substr(1);
      var big = Math.pow(16,10);
      var connect = false;
      var pair;
      var theStream;

      if (code) { // receiving end
        console.log('answerer of ' + code);

        var video = document.createElement('video');
        document.body.appendChild(video);

        startCall();

        peer.on('stream', function(stream) {
          console.log('got stream');
          video.src = window.URL.createObjectURL(stream);
          video.onloadedmetadata = function(e) {
            setTimeout(function () {
              video.play();
            }, 100);
          };
        });

        peer.on('error', function (err) {
          console.error(err);
        });


      } else { // sending end
        console.log('caller');

        code = code || ((Math.random() * big |0)+ big).toString(16);

        document.querySelector('input').value = window.location + '?' + code;

        document.querySelector('.start').addEventListener('click', function (e) {
          console.log('1 2 3 let\'s go');
          navigator.mediaDevices.getUserMedia({video: {
            mediaSource: "screen"
          }}).then(function(stream) {
            theStream = stream;
            startCall(stream);
          }).catch(function(err) {
            console.log('Failed to get local stream' ,err);
          });
        });
      }

      function startCall(stream) {
        peer = new SocketPeer({
          socketFallback: false,
          pairCode: code,
          stream: stream,
          url: 'wss://socketpeer-media.herokuapp.com/socketpeer/'
        });
      }

      window.onerror = function (m) {
        document.querySelector('video').remove();
        document.querySelector('input').value = m;
      };

    </script>
  </body>
</html>
