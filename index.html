<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
      }
      div {
        font-size: 2em;
        width: 99%;
      }
    </style>
  </head>
  <body>
    <select class="screen"></select>
    <button class="start">start</button>
    <button class="stop">stop</button>
    <div></div>
    <script src="//socketpeer-media.herokuapp.com/socketpeer/socketpeer.js"></script>
    <script>

      var server = 'https://moz-corsica.herokuapp.com/';

      var currentScreen;

      function sendCommand(command, screen) {
        command += ' screen=' + (screen || currentScreen);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', server + 'api/command', true);

        xhr.send(
          new Blob(
            [JSON.stringify({
              raw:command
            })],
            {'type': 'application/json'}
          )
        );
      }

      function api(path, body) {
        return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', server + 'api/' + path, true);
      	  xhr.onload = function () {
            resolve(JSON.parse(xhr.response))
          };
          xhr.onerror = function (...args) {
            console.log('oh dear, there seems to have been an error');
            reject(...args);
          };
          if (body) {
            xhr.send(
              new Blob(
                [JSON.stringify(body)],
                {'type': 'application/json'}
              )
            );
          } else {
            xhr.send();
          }
        });
      }

      function init() {
        var code = location.search.substr(1);
        var big = Math.pow(16,10);
        var connect = false;
        var pair;
        var theStream;

        if (code) { // receiving end
          console.log('answerer of ' + code);

          var video = document.createElement('video');
          document.body.appendChild(video);

          startCall(code);

          peer.on('stream', function(stream) {
            console.log('got stream');
            video.src = window.URL.createObjectURL(stream);
            video.onloadedmetadata = function(e) {
              setTimeout(function () {
                video.play();
              }, 100);
            };
          });

          peer.on('error', function (err) {
            console.error(err);
          });


        } else { // sending end

          currentScreen = localStorage.getItem('currentscreen');

          console.log('caller');

          api('census.clients').then(updateSelect);

          code = code || ((Math.random() * big |0)+ big).toString(16);

          var destinationURL = window.location + '?' + code;

          document.querySelector('.start').addEventListener('click', function (e) {
            console.log('1 2 3 let\'s go');
            navigator.mediaDevices.getUserMedia({video: {
              mediaSource: "screen"
            }}).then(function(stream) {
              sendCommand(destinationURL, currentScreen);
              theStream = stream;
              startCall(code, stream);
            }).catch(function(err) {
              console.log('Failed to get local stream' ,err);
            });
          });

          document.querySelector('.stop').addEventListener('click', function (e) {
            sendCommand('reset', currentScreen);
          });
        }
      }


      function startCall(code, stream) {
        peer = new SocketPeer({
          socketFallback: false,
          pairCode: code,
          stream: stream,
          url: 'wss://socketpeer-media.herokuapp.com/socketpeer/'
        });
      }

      var select = document.querySelector('.screen');

      select.addEventListener('change', function (e) {
        currentScreen = select.value;
        localStorage.setItem('currentscreen', currentScreen);
      });

      select.addEventListener('input', function (e) {
        currentScreen = select.value;
        localStorage.setItem('currentscreen', currentScreen);
      });

      function updateSelect(census) {
        var clients = census.clients;
        while (select.childNodes.length) {
          select.firstChild.remove();
        }
        clients.sort();
        clients.unshift('');
        clients.forEach(function (c) {
          var o = document.createElement('option');
          if (c === currentScreen) {
            o.setAttribute('selected', true);
          }
          o.value = c;
          o.innerHTML = c;
          select.appendChild(o);
        });
        setTimeout(function () {
          api('census.clients').then(updateSelect);
        }, 30 * 1000);
      }

      window.onerror = function (m) {
        var video = document.querySelector('video');
        if (video) {
          video.remove();
        }
        document.querySelector('div').innerHTML = m;
      };

      window.addEventListener('load', init);

    </script>
  </body>
</html>
