<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
      }
    </style>
  </head>
  <body>
    <button class="start">go</button>
    <button class="reset">reset</button>
    <script src="node_modules/peerjs_fork_firefox40/dist/peer.js"></script>
    <script>
      var code = location.search.substr(1);
      var big = Math.pow(16,10);
      var connect = false;

      var peer;
      var theStream;

      if (code) { // receiving end
        console.log('answerer of ' + code);
        code = code + '-receive'
        peer = new Peer(code, {key: 'p6w6fypd9fqolxr'});

        var video = document.createElement('video');
        document.body.appendChild(video);

        peer.on('call', function(call) {
          console.log('received call');
          call.answer(); // Answer the call with an A/V stream.
          call.on('stream', function(remoteStream) {
            console.log('got stream');
            video.src = window.URL.createObjectURL(remoteStream);
            video.onloadedmetadata = function(e) {
              video.play();
            };
          });
        });

        peer.on('error', function (err) {
          console.error(err);
        });

      } else { // sending end
        console.log('caller');
        code = ((Math.random() * big |0)+ big).toString(16);
        history.replaceState(null, null, "?" + code);

        peer = new Peer(code, {key: 'p6w6fypd9fqolxr'});

        document.querySelector('.start').addEventListener('click', function (e) {
          console.log('1 2 3 let\'s go');
          navigator.mediaDevices.getUserMedia(video: {
            mediaSource: "window"
          }).then(function(stream) {
            theStream = stream;
            var call = peer.call(code + '-receive', stream);
          }).catch(function(err) {
            console.log('Failed to get local stream' ,err);
          });
        });
      }

      document.querySelector('.reset').addEventListener('click', function (e) {
        if (peer) {
          peer.destroy();
          peer = null;
        }

        try {
          theStream.stop();
        } catch (e) {
        }

        code = ((Math.random() * big |0)+ big).toString(16);
        history.replaceState(null, null, "?" + code);

        peer = new Peer(code, {key: 'p6w6fypd9fqolxr'});
      });
    </script>
  </body>
</html>
